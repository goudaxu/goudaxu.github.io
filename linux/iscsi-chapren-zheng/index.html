<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css" integrity="sha384-IJLmUY0f1ePPX6uSCJ9Bxik64/meJmjSYD7dHaJqTXXEBE4y+Oe9P2KBZa/z7p0Q" crossorigin="anonymous">
  <link href="https://www.xuhaoda.com/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Gouda&#x27;s Blog | ISCSI_CHAP认证

  </title>

  
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js" integrity="sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT" crossorigin="anonymous"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
  
  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;www.xuhaoda.com">Gouda&#x27;s Blog</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;">
            主页
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;posts">
            常用
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;docs">
            Docs
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;linux">
            Linux
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;ruby">
            Ruby
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;tags">
            标签
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;categories">
            分类
          </a>
          
          
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            ISCSI_CHAP认证
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Gouda published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2021-12-04">December 04, 2021</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>8 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>1525 words</span>
</span>

            </div>
            <div class="column">
              
              
<p>
  Categories:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://www.xuhaoda.com/categories/linux/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>linux</span>
    </span>
  </a>
  
</p>

              
            </div>
            <div class="column has-text-right-desktop">
              
              
<p>
  Tags:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://www.xuhaoda.com/tags/linux/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>linux</span>
    </span>
  </a>
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://www.xuhaoda.com/tags/iscsi/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>iscsi</span>
    </span>
  </a>
  
</p>

              
            </div>
          </div>
          <div class="content mt-2">
            <h1 id="deng-lu-chapren-zheng-de-iscsi-target">登录CHAP认证的iSCSI target</h1>
<p>使用iStorage Server为linux服务器创建iSCSI target ，iStorage Server 支持CHAP在内的多种认证方法，而CHAP是目前IP SAN领域最常用的安全机制。</p>
<p>iStorage Server是kernsafe旗下的一款优秀的IP SAN服务器软件，创建target方法，可以查看官网白皮书：www.kernsafe.cn</p>
<h4 id="di-yi-chong-quan-ju-pei-zhi-de-fang-fa-ke-hu-duan-shang-lian-jie-de-suo-you-targetke-neng-du-hui-shi-yong-zhe-ge-zhang-hao-he-mi-ma-jin-xing-ren-zheng-gua-yong-yu-zhi-you-yi-ge-target">第一种：全局配置的方法，客户端上连接的所有target可能都会使用这个账号和密码进行认证，适用于只有一个target</h4>
<pre style="background-color:#2b303b;color:#6c7079;"><code><span style="color:#abb2bf;">[root@www ~]# yum -y install iscsi-initiator-utils</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# vi /etc/iscsi/iscsid.conf</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># line 49: uncomment</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.authmethod = CHAP</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># line 53,54: uncomment and set username and password which set on iSCSI Target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.username = username</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.password = password</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># discover target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# iscsiadm -m discovery -t sendtargets -p 10.0.0.30</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">Starting iscsid: Loading iSCSI transport class v2.0-870.</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsi: registered transport (tcp)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsi: registered transport (iser)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">cxgb3i: tag itt 0x1fff, 13 bits, age 0xf, 4 bits.</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsi: registered transport (cxgb3i)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">cnic: Broadcom NetXtreme II CNIC Driver cnic v2.1.2 (May 26, 2010)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">Broadcom NetXtreme II iSCSI Driver bnx2i v2.1.1 (Mar 24, 2010)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsi: registered transport (bnx2i)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsi: registered transport (be2iscsi)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[ OK ]</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">10.0.0.30:3260,1 iqn.2011-07.world.server:target0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# chkconfig iscsi on</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# chkconfig iscsid on</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># login to target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# iscsiadm -m node --login</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">Logging in to [iface: default, target: iqn.2011-07.world.server:target0, portal: 10.0.0.30,3260]</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">scsi2 : iSCSI Initiator over TCP/IP</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">scsi 2:0:0:0: RAID IET Controller 0001 PQ: 0 ANSI: 5</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">scsi 2:0:0:1: Direct-Access IET VIRTUAL-DISK 0001 PQ: 0 ANSI: 5</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">Login to [iface: default, target: iqn.2011-07.world.server:target0, portal: 10.0.0.30,3260] successful.</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># confirm session</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# iscsiadm -m session -o show</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">tcp: [1] 10.0.0.30:3260,1 iqn.2011-07.world.server:target0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># confirm partitions</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# cat /proc/partitions</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">major minor #blocks name</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">8031457280sda</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">81512000sda1</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">8230944256sda2</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">253020971520dm-0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">25316160384dm-1</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">25323809280dm-2</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">80104857600sdb</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">81104857600sdb1# added new device provided from target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># config for auto-mount when booting</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# vi /etc/fstab</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">/dev/mapper/VolGroup-lv_root / ext4 defaults 1 1</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">UUID=3d3f19a1-582f-4a29-a304-349750094b2c /boot ext4 defaults 1 2</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">/dev/mapper/VolGroup-lv_swap swap swap defaults 0 0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">tmpfs /dev/shm tmpfs defaults 0 0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">devpts /dev/pts devpts gid=5,mode=620 0 0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">sysfs /sys sysfs defaults 0 0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">proc /proc proc defaults 0 0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># add iSCSI filesystem</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">/dev/sdb1 /var/kvm ext4 _netdev 0 0</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@www ~]# chkconfig netfs on</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">________________________________________________________________________________________________</span><span style="color:#abb2bf;">
</span></code></pre>
<h4 id="fang-fa-er-dui-te-ding-de-targetjin-xing-xiu-gai-jia-ru-wo-men-tong-shi-lian-jie-liao-duo-ge-target-bi-xu-zhe-yang">方法二：对特定的target进行修改(假如我们同时连接了多个target，必须这样)</h4>
<pre style="background-color:#2b303b;color:#6c7079;"><code><span style="color:#abb2bf;">http://zlbzhu.blog.51cto.com/1413424/897422</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">发现target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm -m discovery -t sendtargets -p 192.168.1.211</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">挂载target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm -m node -T iqn_2013-06.com.safexjt:target00 -p 192.168.1.211 -l</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">配置该target,默认放在客户端/var/lib/iscsi/node下面</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">vi /var/lib/iscsi/nodes/iqn_2013-06.com.safexjt\:target00/192.168.1.211\,3260\,1/default</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">在node.session.*.* 段添加如下信息</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.authmethod = CHAP</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.username = jack</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.password = jack</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">保存</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">#service iscsi restart</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">________________________________________________________________________________________________</span><span style="color:#abb2bf;">
</span></code></pre>
<h4 id="fang-fa-san-ru-guo-wo-men-yi-jing-dui-targetjin-xing-liao-discovery-dan-shi-zai-gua-zai-de-shi-hou-ti-shi-ren-zheng-shi-bai-zhe-ge-shi-hou-wo-men-ye-ke-yi-tong-guo-iscsiadmming-ming-jin-xing-tian-jia-ren-zheng-xin-xi">方法三：如果我们已经对target进行了discovery，但是在挂载的时候提示认证失败，这个时候我们也可以通过iscsiadm明明进行添加认证信息</h4>
<pre style="background-color:#2b303b;color:#6c7079;"><code><span style="color:#abb2bf;">root@iscsi /]#iscsiadm -m node -T iqn_2013-06.com.safexjt:target00 -p 192.168.1.211:3260 -o update --name=node.session.auth.authmethod --value=CHAP</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@iscsi /]#iscsiadm -m node -T iqn_2013-06.com.safexjt:target00 -p 192.168.1.211:3260 -o update --name= node.session.auth.username --value=xxxxxxx</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">[root@iscsi /]#iscsiadm -m node -T iqn_2013-06.com.safexjt:target00 -p 192.168.1.211:3260 -o update --name= node.session.auth.password --value=xxxxxxx</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">需要注意的是，发现Target的命令（iscsiadm -m discovery -t sendtargets）会自动按照/etc/iscsi/iscsi.conf文件中的参数配置刷新/var/lib/iscsi/nodes下initiator登录target要使用的参数文件，所以如果通过修改/var/lib/iscsi/nodes下的文件设置好CHAP认证后又对该存储服务器执行了发现target的操作，则需要再次修改该文件。</span><span style="color:#abb2bf;">
</span></code></pre>
<hr />
<hr />
<h3 id="yi-dan-xiang-ren-zheng">一、单向认证</h3>
<p>单向认证是仅initiator连接target时进行认证。这个配置比较简单，打开/etc/iscsi/iscsid.conf 文件，找到如下三项并取消注释：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#abb2bf;">node.session.auth.authmethod </span><span style="color:#adb7c9;">= </span><span style="color:#db9d63;">CHAP   </span><span style="font-style:italic;color:#5f697a;">//开启CHAP认证</span><span style="font-style:italic;color:#5f697a;">
</span><span style="color:#abb2bf;">node.session.auth.username </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> redhat    </span><span style="font-style:italic;color:#5f697a;">//配置账号</span><span style="font-style:italic;color:#5f697a;">
</span><span style="color:#abb2bf;">node.session.auth.password </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> redhat123  </span><span style="font-style:italic;color:#5f697a;">//密码</span><span style="font-style:italic;color:#5f697a;">
</span></code></pre>
<p>通过以下命令重启服务并生效：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#adb7c9;">/</span><span style="color:#abb2bf;">etc</span><span style="color:#adb7c9;">/</span><span style="color:#abb2bf;">init.d</span><span style="color:#adb7c9;">/</span><span style="color:#abb2bf;">iscsid restart</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">或</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">systemctl restart iscsid</span><span style="color:#abb2bf;">
</span></code></pre>
<p>上面的配置只是在开机自启动时会查找该配置中的信息，如果想要通过命令行测试用户名密码的有效性可以使用如下命令：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#abb2bf;"># 发现target</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m discovery </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">t sendtargets </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">p </span><span style="color:#db9d63;">10.131.131.150  </span><span style="font-style:italic;color:#5f697a;">//发现</span><span style="font-style:italic;color:#5f697a;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> iqn</span><span style="color:#db9d63;">.2006</span><span style="color:#adb7c9;">-</span><span style="color:#db9d63;">08.</span><span style="color:#abb2bf;">com.huawei</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">oceanstor</span><span style="color:#adb7c9;">:</span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">l   </span><span style="font-style:italic;color:#5f697a;">//登陆</span><span style="font-style:italic;color:#5f697a;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o delete </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> iqn</span><span style="color:#db9d63;">.2006</span><span style="color:#adb7c9;">-</span><span style="color:#db9d63;">08.</span><span style="color:#abb2bf;">com.huawei</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">oceanstor</span><span style="color:#adb7c9;">:</span><span style="color:#db9d63;">10.131.131.150 </span><span style="font-style:italic;color:#5f697a;">//删除session</span><span style="font-style:italic;color:#5f697a;">
</span><span style="color:#abb2bf;"># 使用用户名密码</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o update </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">p </span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">n node.session.auth.authmethod </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">v </span><span style="color:#db9d63;">CHAP</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o update </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">p </span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">n node.session.auth.username </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">v myusername</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o update </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">p </span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">n node.session.auth.password </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">v mypassword</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># 也可以使用下面的格式</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> iqn</span><span style="color:#db9d63;">.2006</span><span style="color:#adb7c9;">-</span><span style="color:#db9d63;">08.</span><span style="color:#abb2bf;">com.huawei</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">oceanstor</span><span style="color:#adb7c9;">:</span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o update </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">name node.session.auth.authmethod </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">value</span><span style="color:#adb7c9;">=</span><span style="color:#db9d63;">CHAP</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> iqn</span><span style="color:#db9d63;">.2006</span><span style="color:#adb7c9;">-</span><span style="color:#db9d63;">08.</span><span style="color:#abb2bf;">com.huawei</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">oceanstor</span><span style="color:#adb7c9;">:</span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">op update </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">name node.session.auth.username </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">value</span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;">myusername</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> iqn</span><span style="color:#db9d63;">.2006</span><span style="color:#adb7c9;">-</span><span style="color:#db9d63;">08.</span><span style="color:#abb2bf;">com.huawei</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">oceanstor</span><span style="color:#adb7c9;">:</span><span style="color:#db9d63;">10.131.131.150 </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">op update </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">name node.session.auth.password </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">value</span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;">mypassword</span><span style="color:#abb2bf;">
</span></code></pre>
<p>连接后，可以使用如下命令查看连接状态：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#abb2bf;"># 查看状态</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o show</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># 查看连接后状态</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m session </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o show</span><span style="color:#abb2bf;">
</span></code></pre>
<p>上面的连接状态信息，也可以通过进入/var/lib/iscsi/ifaces/目录通过查看文件进行查看。对于已经连接过的session，可以使用如下命令删除该session：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#cd74e8;">for</span><span style="color:#abb2bf;"> iqn in `iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node</span><span style="color:#adb7c9;">|</span><span style="color:#abb2bf;">awk </span><span style="color:#9acc76;">&#39;{print $NF}&#39;</span><span style="color:#abb2bf;">`;</span><span style="color:#cd74e8;">do</span><span style="color:#abb2bf;"> iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> $iqn </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">u;done</span><span style="color:#abb2bf;">
</span><span style="color:#cd74e8;">for</span><span style="color:#abb2bf;"> iqn in `iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node</span><span style="color:#adb7c9;">|</span><span style="color:#abb2bf;">awk </span><span style="color:#9acc76;">&#39;{print $NF}&#39;</span><span style="color:#abb2bf;">`;</span><span style="color:#cd74e8;">do</span><span style="color:#abb2bf;"> iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">o delete </span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">T</span><span style="color:#abb2bf;"> $iqn;done</span><span style="color:#abb2bf;">
</span></code></pre>
<h3 id="er-shuang-xiang-ren-zheng">二、双向认证</h3>
<p>双向认证就是在Initiator端和target端都进行认证。Initiator 认证：在initiator尝试连接到一个target的时候，initator需要提供一个用户名和密码给target供target进行认证。下面我们称这个用户名密码为incoming账号，即：incoming账号是initiator端提供给target端，供target端认证的账号。target 认证：在initiator尝试连接到一个target的时候，target需要提供一个用户名和密码给initiator供initiator进行认证。与之对应的是outcoming账号，即：outcoming账号是target端提供给initiator端，供initiator认证的账号。双向认证的配置如下：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#abb2bf;"># </span><span style="color:#f0c678;">To</span><span style="color:#abb2bf;"> set a </span><span style="color:#db9d63;">CHAP</span><span style="color:#abb2bf;"> username and password </span><span style="color:#cd74e8;">for</span><span style="color:#abb2bf;"> initiator</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># authentication by the </span><span style="color:#eb6772;">target</span><span style="color:#abb2bf;">(s), uncomment the following lines</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.username </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> username</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.password </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> password</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># </span><span style="color:#f0c678;">To</span><span style="color:#abb2bf;"> set a </span><span style="color:#db9d63;">CHAP</span><span style="color:#abb2bf;"> username and password </span><span style="color:#cd74e8;">for </span><span style="color:#eb6772;">target</span><span style="color:#abb2bf;">(s)</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;"># authentication by the initiator, uncomment the following lines</span><span style="color:#adb7c9;">:</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.username_in </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> username_in</span><span style="color:#abb2bf;">
</span><span style="color:#abb2bf;">node.session.auth.password_in </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> password_in</span><span style="color:#abb2bf;">
</span></code></pre>
<h3 id="san-you-guan-duo-lu-jing-ju-he">三、有关多路径聚合</h3>
<p>存储端一般会有多控，也就是可以由多个对应的IP可供discovery 和 login使用，比如一个两控的就会使用如下的方式进行挂载：</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#abb2bf;"># iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">p </span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">存储系统A控iSCSI主机端口的IP</span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">A</span><span style="color:#adb7c9;">&gt; -</span><span style="color:#abb2bf;">l# iscsiadm </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">m node </span><span style="color:#adb7c9;">-</span><span style="color:#abb2bf;">p </span><span style="color:#adb7c9;">&lt;</span><span style="color:#abb2bf;">存储系统B控iSCSI主机端口的IP</span><span style="color:#adb7c9;">-</span><span style="color:#f0c678;">B</span><span style="color:#adb7c9;">&gt; -</span><span style="color:#abb2bf;">l</span><span style="color:#abb2bf;">
</span></code></pre>
<p>接下来可以使用多路径软件进行聚合，这里以multipath为例，使用如下指令生成配置文件并重启服务生效。</p>
<pre data-lang="bsh" style="background-color:#2b303b;color:#6c7079;" class="language-bsh "><code class="language-bsh" data-lang="bsh"><span style="color:#abb2bf;"># mpathconf </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">enable# mpathconf </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">with_module y# mpathconf </span><span style="color:#adb7c9;">--</span><span style="color:#abb2bf;">with_multipathd y</span><span style="color:#abb2bf;">
</span></code></pre>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;linux&#x2F;fei-lvmwu-sun-kuo-zhan-ying-pan-fen-qu&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              非LVM无损扩展硬盘分区(不推荐)
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;www.xuhaoda.com&#x2F;linux&#x2F;linuxxia-yan-zheng-qi-dong-mo-shi-biosoruefi&#x2F;">
              linux下验证启动模式是BIOS还是UEFI<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>



  



  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js" integrity="sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js" integrity="sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs" crossorigin="anonymous"></script>
  
  
  <script src="https://www.xuhaoda.com/elasticlunr.min.js"></script>
  <script src="https://www.xuhaoda.com/search_index.en.js"></script><script src="https://www.xuhaoda.com/js/site.js"></script>

  





  
  
</body>

</html>
